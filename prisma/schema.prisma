generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
// ENUMS
//

enum ProductStatus {
  ACTIVE
  INACTIVE
}

enum ListingStatus {
  LISTED
  DELISTED
  SUSPENDED
}

enum OrderStatus {
  CREATED
  CONFIRMED
  PACKED
  SHIPPED
  DELIVERED
  CANCELLED
  RETURNED
}

enum OversellPolicy {
  REJECT // no negative stock allowed
  ALLOW // unlimited negative
  LIMITED // allow negative till threshold
}

enum ImageSourceType {
  URL
  LOCAL
}

enum UserRole {
  ADMIN
  MANAGER
  PACKING_CREW
  VIEWER
}

//
// PRODUCT
//

model Product {
  id   String @id @default(uuid())
  sku  String @unique
  name String

  description     String? @db.Text
  metaTitle       String?
  metaDescription String?

  basePrice Float

  totalStock    Int
  reservedStock Int @default(0)

  oversellPolicy OversellPolicy @default(REJECT)
  oversellLimit  Int?

  status ProductStatus @default(ACTIVE)

  attributes Json?

  images    ProductImage[]
  movements InventoryMovement[] // âœ… ADD THIS

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  listings   ChannelListing[]
  orderItems OrderItem[]
}

model ProductImage {
  id        String @id @default(uuid())
  productId String

  sourceType ImageSourceType @default(URL)

  url      String? // for CDN / external
  filePath String? // future local storage

  sortOrder Int @default(0)

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

//
// CHANNEL
//

model Channel {
  id   String @id @default(uuid())
  name String @unique

  baseUrl       String?
  apiKey        String?
  apiSecret     String?
  accessToken   String?
  webhookSecret String?

  isEnabled Boolean @default(false)
  isSandbox Boolean @default(true)

  createdAt DateTime @default(now())

  listings        ChannelListing[]
  orders          Order[]
  integrationLogs IntegrationLog[]
}

//
// CHANNEL LISTING
//

model ChannelListing {
  id        String @id @default(uuid())
  productId String
  channelId String

  marketplaceSku String
  externalId     String?

  currentPrice   Float
  discountAmount Float?
  markupAmount   Float?

  followsBasePrice Boolean @default(true)

  listingStatus ListingStatus @default(DELISTED)
  syncedAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  channel Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  history ChannelListingHistory[]

  @@unique([productId, channelId])
}

//
// LISTING HISTORY
//

model ChannelListingHistory {
  id               String @id @default(uuid())
  channelListingId String

  previousStatus ListingStatus?
  newStatus      ListingStatus
  reason         String?

  changedAt DateTime @default(now())

  listing ChannelListing @relation(fields: [channelListingId], references: [id], onDelete: Cascade)
}

//
// MASTER ORDER
//

model Order {
  id        String @id @default(uuid())
  channelId String

  externalOrderId String
  totalAmount     Float
  discountAmount  Float?
  offerCode       String?

  status OrderStatus @default(CREATED)
  customerCancelledAt DateTime?
  warehouseReceivedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  channel Channel     @relation(fields: [channelId], references: [id], onDelete: Restrict)
  items   OrderItem[]

  @@unique([channelId, externalOrderId])
}

//
// ORDER ITEM
//

model OrderItem {
  id        String @id @default(uuid())
  orderId   String
  productId String

  quantity   Int
  unitPrice  Float
  totalPrice Float

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Restrict)
}

model IntegrationLog {
  id        String   @id @default(uuid())
  channelId String
  eventType String
  payload   Json
  response  Json?
  status    String // SUCCESS / FAILED
  createdAt DateTime @default(now())

  channel Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)
}

enum InventoryMovementType {
  CONFIRM
  CANCEL
  RETURN
  MANUAL_ADJUST
}

model InventoryMovement {
  id        String                @id @default(uuid())
  productId String
  type      InventoryMovementType
  quantity  Int
  reference String? // orderId or manual reason
  createdAt DateTime              @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  name         String
  passwordHash String
  passwordSalt String
  role         UserRole @default(VIEWER)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  sessions Session[]
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}
